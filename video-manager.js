class VideoManager {
    constructor() {
        this.folders = [];
        this.currentUploadFolder = null;
        
        // Ê®°ÊãüÁöÑÊñá‰ª∂Â§πÂíåÊñá‰ª∂Êï∞ÊçÆÔºàÂÆûÈôÖÂ∫îËØ•‰ªéÊúçÂä°Âô®Ëé∑ÂèñÔºâ
        this.mockFolders = [
            {
                name: 'Pika2.2',
                files: [
                    { name: 'video1.mp4', size: '15.2 MB' },
                    { name: 'video2.mp4', size: '18.7 MB' },
                    { name: 'video3.mp4', size: '12.1 MB' }
                ]
            },
            {
                name: 'Pika2.5', 
                files: [
                    { name: 'sample1.mp4', size: '20.3 MB' },
                    { name: 'sample2.mp4', size: '16.8 MB' }
                ]
            },
            {
                name: 'Pika 2.2 DMD',
                files: [
                    { name: 'dmd_test1.mp4', size: '22.1 MB' },
                    { name: 'dmd_test2.mp4', size: '19.5 MB' },
                    { name: 'dmd_test3.mp4', size: '25.0 MB' }
                ]
            }
        ];
    }

    init() {
        this.loadFolders();
        this.bindEvents();
        this.renderFolders();
    }

    loadFolders() {
        // Âä†ËΩΩÁé∞ÊúâÊñá‰ª∂Â§πÊï∞ÊçÆÔºàËøôÈáå‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆÔºâ
        this.folders = [...this.mockFolders];
        
        // ‰πüÂèØ‰ª•‰ªé localStorage Âä†ËΩΩÁî®Êà∑ÂàõÂª∫ÁöÑÊñá‰ª∂Â§π
        const customFolders = JSON.parse(localStorage.getItem('custom_folders') || '[]');
        this.folders.push(...customFolders);
    }

    bindEvents() {
        // Ê∑ªÂä†Êñá‰ª∂Â§πÊåâÈíÆ
        document.getElementById('addFolderBtn').addEventListener('click', () => this.addNewFolder());
        
        // ÂõûËΩ¶ÈîÆÂàõÂª∫Êñá‰ª∂Â§π
        document.getElementById('newFolderName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.addNewFolder();
            }
        });

        // Êñá‰ª∂ËæìÂÖ•ÂèòÂåñ
        document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileSelect(e));
    }

    addNewFolder() {
        const input = document.getElementById('newFolderName');
        const folderName = input.value.trim();

        if (!folderName) {
            this.showMessage('Please enter a folder name', 'error');
            return;
        }

        // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ÂêåÂêçÊñá‰ª∂Â§π
        if (this.folders.some(folder => folder.name === folderName)) {
            this.showMessage('A folder with this name already exists', 'error');
            return;
        }

        // ÂàõÂª∫Êñ∞Êñá‰ª∂Â§π
        const newFolder = {
            name: folderName,
            files: [],
            isCustom: true
        };

        this.folders.push(newFolder);
        
        // ‰øùÂ≠òÂà∞ localStorage
        const customFolders = this.folders.filter(f => f.isCustom);
        localStorage.setItem('custom_folders', JSON.stringify(customFolders));

        // ÈáçÊñ∞Ê∏≤Êüì
        this.renderFolders();
        
        // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
        input.value = '';
        
        this.showMessage(`Folder "${folderName}" created successfully!`, 'success');
    }

    renderFolders() {
        const container = document.getElementById('videoFolders');
        container.innerHTML = '';

        this.folders.forEach(folder => {
            const folderCard = this.createFolderCard(folder);
            container.appendChild(folderCard);
        });
    }

    createFolderCard(folder) {
        const card = document.createElement('div');
        card.className = 'folder-card';
        
        card.innerHTML = `
            <div class="folder-header">
                <div class="folder-name">${folder.name}</div>
                <div class="file-count">${folder.files.length} files</div>
            </div>
            
            <div class="upload-area" data-folder="${folder.name}">
                <div class="upload-icon">üìÅ</div>
                <div><strong>Click to upload videos</strong></div>
                <div style="margin-top: 5px; color: #6b7280; font-size: 0.9rem;">
                    Or drag and drop video files here
                </div>
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
            </div>
            
            <div class="file-list">
                ${folder.files.map(file => `
                    <div class="file-item">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${file.size}</div>
                        <div class="delete-file" onclick="videoManager.deleteFile('${folder.name}', '${file.name}')">
                            üóëÔ∏è
                        </div>
                    </div>
                `).join('')}
            </div>
            
            ${folder.isCustom ? `
                <div style="margin-top: 15px; text-align: center;">
                    <button onclick="videoManager.deleteFolder('${folder.name}')" 
                            style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                        Delete Folder
                    </button>
                </div>
            ` : ''}
        `;

        // ÁªëÂÆö‰∏ä‰º†Âå∫Âüü‰∫ã‰ª∂
        const uploadArea = card.querySelector('.upload-area');
        this.bindUploadEvents(uploadArea, folder.name);

        return card;
    }

    bindUploadEvents(uploadArea, folderName) {
        // ÁÇπÂáª‰∏ä‰º†
        uploadArea.addEventListener('click', () => {
            this.currentUploadFolder = folderName;
            document.getElementById('fileInput').click();
        });

        // ÊãñÊãΩ‰∏ä‰º†
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            this.currentUploadFolder = folderName;
            this.handleFileUpload(e.dataTransfer.files);
        });
    }

    handleFileSelect(event) {
        if (this.currentUploadFolder) {
            this.handleFileUpload(event.target.files);
        }
    }

    handleFileUpload(files) {
        if (!this.currentUploadFolder) return;

        const videoFiles = Array.from(files).filter(file => 
            file.type.startsWith('video/') || file.name.toLowerCase().endsWith('.mp4')
        );

        if (videoFiles.length === 0) {
            this.showMessage('Please select valid video files (.mp4)', 'error');
            return;
        }

        // Ê®°ÊãüÊñá‰ª∂‰∏ä‰º†
        this.simulateUpload(videoFiles, this.currentUploadFolder);
    }

    simulateUpload(files, folderName) {
        const folder = this.folders.find(f => f.name === folderName);
        if (!folder) return;

        this.showMessage(`Starting upload of ${files.length} file(s) to ${folderName}...`, 'info');

        // Ê®°Êãü‰∏ä‰º†ËøõÂ∫¶
        files.forEach((file, index) => {
            setTimeout(() => {
                // Ê∑ªÂä†Êñá‰ª∂Âà∞Êñá‰ª∂Â§π
                const newFile = {
                    name: file.name,
                    size: this.formatFileSize(file.size)
                };

                folder.files.push(newFile);

                // Â¶ÇÊûúÊòØËá™ÂÆö‰πâÊñá‰ª∂Â§πÔºå‰øùÂ≠òÂà∞ localStorage
                if (folder.isCustom) {
                    const customFolders = this.folders.filter(f => f.isCustom);
                    localStorage.setItem('custom_folders', JSON.stringify(customFolders));
                }

                // ÈáçÊñ∞Ê∏≤ÊüìÊñá‰ª∂Â§π
                this.renderFolders();

                if (index === files.length - 1) {
                    this.showMessage(`Successfully uploaded ${files.length} file(s) to ${folderName}!`, 'success');
                }
            }, (index + 1) * 1000); // Ê®°Êãü‰∏ä‰º†Âª∂Ëøü
        });
    }

    deleteFile(folderName, fileName) {
        if (!confirm(`Are you sure you want to delete "${fileName}"?`)) {
            return;
        }

        const folder = this.folders.find(f => f.name === folderName);
        if (folder) {
            folder.files = folder.files.filter(file => file.name !== fileName);
            
            // Â¶ÇÊûúÊòØËá™ÂÆö‰πâÊñá‰ª∂Â§πÔºåÊõ¥Êñ∞ localStorage
            if (folder.isCustom) {
                const customFolders = this.folders.filter(f => f.isCustom);
                localStorage.setItem('custom_folders', JSON.stringify(customFolders));
            }
            
            this.renderFolders();
            this.showMessage(`File "${fileName}" deleted successfully`, 'success');
        }
    }

    deleteFolder(folderName) {
        if (!confirm(`Are you sure you want to delete the entire folder "${folderName}" and all its files?`)) {
            return;
        }

        this.folders = this.folders.filter(f => f.name !== folderName);
        
        // Êõ¥Êñ∞ localStorage
        const customFolders = this.folders.filter(f => f.isCustom);
        localStorage.setItem('custom_folders', JSON.stringify(customFolders));
        
        this.renderFolders();
        this.showMessage(`Folder "${folderName}" deleted successfully`, 'success');
    }

    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    showMessage(text, type = 'info') {
        const message = document.createElement('div');
        message.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1'};
            color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460'};
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            font-weight: 600;
            max-width: 400px;
        `;
        message.textContent = text;
        document.body.appendChild(message);

        setTimeout(() => {
            message.remove();
        }, 4000);
    }
}

// ÂÖ®Â±ÄÂèòÈáè‰ª•‰æøÂú® HTML onclick ‰∏≠‰ΩøÁî®
let videoManager;

// ÂàùÂßãÂåñÂ∫îÁî®
document.addEventListener('DOMContentLoaded', () => {
    videoManager = new VideoManager();
    videoManager.init();
}); 